<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-time Digital Avatar Chat</title>
    <script src="./js/live2dcubismcore.min.js"></script>
    <script src="./js/live2d.min.js"></script>
    <script src="./js/pixi.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="./js/cubism4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <style>
        #chatBox {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            width: 300px;
            height: 500px;
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
        }
        #startButton {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
<canvas id="canvas"></canvas>

<!-- Start Chat Button -->
<button id="startButton">开始聊天</button>

<!-- Chat Box -->
<div id="chatBox">
    <h4>聊天框</h4>
    <div id="chatContent"></div>
</div>

<script type="text/javascript">
    const cubism4Model = "./assets/kei_vowels_pro/kei_vowels_pro.model3.json";
    const live2d = PIXI.live2d;

    // Initialize the Live2D model
    (async function main() {
        const app = new PIXI.Application({
            view: document.getElementById("canvas"),
            autoStart: true,
            resizeTo: window,
            backgroundColor: 0x333333
        });

        const model = await live2d.Live2DModel.from(cubism4Model);
        app.stage.addChild(model);

        const scaleX = innerWidth / model.width;
        const scaleY = innerHeight / model.height;
        model.scale.set(Math.min(scaleX, scaleY));
        model.y = innerHeight * 0.1;
        model.x = (innerWidth - model.width) / 2;

        // Hide chat box initially
        document.getElementById('chatBox').style.display = "none";
    })();

    let chatContent = ""; // Variable to store the chat content

// Function to handle ASR, LLM, and TTS in a continuous loop
function startListening(model) {
    setInterval(() => {
        // Step 1: Get live audio from the backend (ASR)
        axios.get("http://127.0.0.1:2020/start_record")
            .then(response => {
                const text = response.data.transcription;
                // Append user text
                chatContent += "<div>用户: " + text + "</div>";
                updateChatBox(); // Update chat box after user input

                // Step 2: Send transcription to LLM
                return axios.post("http://127.0.0.1:2020/ask_llm", { text: text });
            })
            .then(response => {
                const llmResponse = response.data.reply;
                // Append AI text
                chatContent += "<div>AI: " + llmResponse + "</div>";
                updateChatBox(); // Update chat box after AI response

                // Step 3: Send LLM reply to TTS for audio generation
                return axios.get(`http://127.0.0.1:2020/tts?text=${encodeURIComponent(llmResponse)}`);
            })
            .then(response => {
                const audioUrl = response.data.audio_file+ "?t=" + new Date().getTime();;

                // Step 4: Make the avatar speak using the generated audio
                talk(model, audioUrl);
            })
            .catch(error => {
                console.error('Error in ASR-LLM-TTS loop:', error);
            });
    }, 5000);  // Adjust the interval as needed
}

// Function to update the chat box content
function updateChatBox() {
    // Display the chat content in the chat box
    document.getElementById("chatContent").innerHTML = chatContent;
}



    // Function to make the model speak
    function talk(model, audioUrl) {
        const audio = new Audio(audioUrl);
        audio.crossOrigin = "anonymous";
        audio.play().catch(error => {
            console.error('Error during audio playback:', error);
        });

        // Optionally, you can add some visual feedback to the model when it speaks
        model.motion("idle", 0);  // Assuming "idle" is a valid motion name
    }

    // Show chat box and start the conversation when the "开始聊天" button is clicked
    document.getElementById('startButton').addEventListener('click', () => {
        document.getElementById('startButton').style.display = "none";  // Hide the start button
        document.getElementById('chatBox').style.display = "block";    // Show the chat box
        startListening();  // Start listening after the button is clicked
    });
</script>
</body>
</html>
